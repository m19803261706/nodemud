# PRD: give + examine 基础指令

## 基本信息

- **创建时间**: 2026-02-05
- **优先级**: P1（高）
- **技术栈**: TypeScript (NestJS 后端)
- **规模**: S（小）— 纯后端，2 个新指令 + 1 个钩子扩展
- **关联 Epic**: #156 物品系统 Phase 1（已完成）、#166 背包系统细化（已完成）

## 功能概述

为物品系统补全两个 P0 核心指令：

1. **examine（详细查看）** — 比 `look` 更详细的物品/NPC 鉴定，显示完整属性、特殊标签、可用操作等
2. **give（给予物品）** — 将背包物品交给房间中的 NPC，触发 NPC 接收钩子（为后续 NPC 任务系统铺路）

## 用户场景

### 场景 1：玩家鉴定物品

玩家获得一件新装备，想了解详细属性：

```
> examine 铁剑

【铁剑】
一把铁质长剑，剑身略有锈迹，但仍保持着基本的锋利...

类型: 武器    重量: 5    价值: 50
攻击: 10-15   部位: weapon
可交易 | 可丢弃
可用操作: 装备、丢弃、查看
```

### 场景 2：玩家鉴定 NPC

玩家仔细观察一个 NPC：

```
> examine 铁匠

【铁匠】♂
「裂隙镇铁匠」 Lv.15 [中立]
一个身材魁梧的中年男子，手臂上满是烧伤的疤痕...

生命: ██████████ 100%
装备: 铁锤(武器) 皮围裙(身体)
```

### 场景 3：玩家给予 NPC 物品

玩家把物品交给 NPC（任务交付场景）：

```
> give 铁矿石 to 铁匠

你把【铁矿石】交给了【铁匠】。
铁匠接过铁矿石，眼前一亮：「好料子！我正缺这个。」
```

### 场景 4：NPC 拒绝物品

```
> give 干粮 to 铁匠

你试图把【干粮】交给【铁匠】。
铁匠摆摆手：「我不需要这个。」
```

## 详细需求

### examine 指令

#### 基本信息

- **指令名**: `examine`
- **别名**: `ex`, `鉴定`, `仔细看`
- **语法**: `examine <目标名>`
- **权限**: std（所有人可用）

#### 查看物品时显示

| 属性         | 来源                        | 始终显示  |
| ------------ | --------------------------- | --------- |
| 名称（加粗） | `getName()`                 | 是        |
| 详细描述     | `getLong()`                 | 是        |
| 类型         | `getType()`                 | 是        |
| 重量 + 价值  | `getWeight()`, `getValue()` | 是        |
| 攻击力       | `get('damage')`             | 仅武器    |
| 防御力       | `get('defense')`            | 仅防具    |
| 回复量       | `get('heal')`               | 仅药品    |
| 装备部位     | `get('wear_position')`      | 武器/防具 |
| 特殊标签     | 不可交易/不可丢弃/唯一      | 有时显示  |
| 可用操作     | `getActions()`              | 是        |

#### 查看 NPC 时显示

| 属性     | 来源                    |
| -------- | ----------------------- |
| 基本信息 | 复用 look 的 NPC 展示   |
| 装备列表 | NPC 的 `getEquipment()` |

#### 搜索优先级

1. 玩家背包物品
2. 房间内 NPC
3. 房间地面物品

#### 无参数时

返回提示："查看什么？用法: examine <目标>"

---

### give 指令

#### 基本信息

- **指令名**: `give`
- **别名**: `给`, `交给`
- **语法**: `give <物品名> to <NPC名>` / `give <物品名> <NPC名>` / `给 <NPC名> <物品名>`
- **权限**: std

#### 执行流程

1. 解析参数，分离物品名和 NPC 名
2. 从玩家背包查找物品（模糊匹配）
3. 在房间内查找 NPC（模糊匹配）
4. 检查物品 `isTradeable()` — 不可交易则拒绝
5. 调用 NPC 的 `onReceiveItem(giver, item)` 钩子
6. 钩子返回 `accept: true` → 物品移动到 NPC（`moveTo`）
7. 钩子返回 `accept: false` → 物品留在玩家背包，显示拒绝消息

#### NpcBase 钩子扩展

在 `NpcBase` 上新增：

```typescript
onReceiveItem(giver: LivingBase, item: ItemBase): { accept: boolean; message?: string }
```

- 默认实现：拒绝所有物品（`{ accept: false }`）
- 蓝图覆写：可实现特定 NPC 接受特定物品的逻辑
- 当前阶段不需要实际的 NPC 蓝图覆写，只需基础框架

#### 参数解析规则

```
give 铁剑 to 铁匠     → itemName="铁剑", npcName="铁匠"
give 铁剑 铁匠         → itemName="铁剑", npcName="铁匠"
给 铁匠 铁剑           → itemName="铁剑", npcName="铁匠"（中文格式：第一个参数是 NPC）
```

#### 错误消息

| 情况         | 消息                                         |
| ------------ | -------------------------------------------- |
| 无参数       | "给什么？给谁？用法: give <物品> to <NPC名>" |
| 物品不在背包 | "你没有这个东西。"                           |
| NPC 不在房间 | "这里没有这个人。"                           |
| 物品不可交易 | "XX不能被交易。"                             |
| NPC 拒绝     | NPC 的自定义消息 或 "XX不需要这个东西。"     |

## 现有代码基础

### 可复用

- **搜索模式**: `getInventory().filter(instanceof).find(includes)` — get/drop/look 中已有
- **物品属性**: `isTradeable()`, `isDroppable()`, `getActions()` — ItemBase 已实现
- **NPC 查找**: `env.getInventory().filter(instanceof NpcBase)` — ask 指令已有
- **富文本**: `rt('item', name)`, `rt('npc', name)`, `bold()` — 已有完整工具集
- **命令注册**: `@Command` 装饰器 + `ICommand` 接口 — 标准模式

### 需新增

- `NpcBase.onReceiveItem()` 钩子方法
- `examine.ts` 命令文件
- `give.ts` 命令文件

## 代码影响范围

- 仅后端（server/）
- 新增 2 个文件
- 修改 1 个文件（npc-base.ts 加钩子）
- 前端无需改动（GameLog 自动渲染富文本消息）

## 任务拆分（初步）

1. NpcBase 新增 `onReceiveItem` 钩子 + examine 指令实现
2. give 指令实现 + 参数解析
3. （可选）部分 NPC 蓝图覆写 onReceiveItem

## 验收标准

- [ ] `examine 铁剑` 显示完整物品属性（类型、重量、价值、攻击力、可用操作等）
- [ ] `examine 酒保` 显示 NPC 详细信息
- [ ] `examine` 无参数时显示用法提示
- [ ] `give 铁剑 to 酒保` 触发 NPC 钩子，默认拒绝并显示消息
- [ ] `give 铁剑 酒保` 简写格式正常工作
- [ ] 给 NPC 不可交易物品时显示拒绝消息
- [ ] 物品不在背包/NPC 不在房间时显示正确错误消息
- [ ] 富文本标记正确（物品名、NPC 名有语义标签）
- [ ] 指令别名（ex、鉴定、给）正常工作

---

> CX 工作流 | PRD
