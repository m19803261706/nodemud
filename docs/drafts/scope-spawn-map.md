# 功能探讨: 出生点地图 — 裂隙镇

## 基本信息

- **创建时间**: 2026-02-02
- **关联项目蓝图**: #1（NodeMUD 项目蓝图）
- **关联世界观**: #84（天衍世界观设定）
- **前置依赖**: Layer 0-4 引擎全部完成，世界观确定

## 功能目标

设计并实现天衍世界的玩家出生点——**裂隙镇**。这是玩家创建角色后踏入的第一个地点，也是向外辐射到各区域的枢纽。

核心要求：
1. **八方向出口系统** — 前端可用九宫格移动按钮
2. **规则化坐标系统** — 前端可展示附近地图
3. **支持快速寻路** — 坐标严格对应方向偏移，为 A*/BFS 寻路算法预留

## 裂隙镇世界观背景

> 天裂之劫后，天地灵脉崩裂，中原边缘的大地被撕开一条巨大裂谷。三百年过去，裂谷两侧的断崖依然高耸，但谷底已被人烟填满。因为地处各方势力交界，反而成了一个中立的贸易落脚点。
>
> 裂隙镇不大，南北一条主街，东西几间铺面，却是天衍世界消息最灵通的地方——承天朝的密探、北漠的行商、江南暗河的耳目、甚至百蛮的药师，都在这个小镇的酒馆里交换着各自的秘密。

### 各出身角色汇聚理由

| 出身 | 来到裂隙镇的理由 |
|------|-----------------|
| 世家子弟 | 追寻中古纪遗迹线索，裂谷中有天裂形成的古迹 |
| 江湖浪子 | 四处游荡到此，裂隙镇是消息最灵通的地方 |
| 书院学子 | 追踪古籍记载来此考察天裂遗迹 |
| 边塞军卒 | 退役后南下谋生，裂谷是北境通往中原的必经之路 |
| 山野药童 | 下山采购交易药材，裂谷中有独特的裂隙草药 |
| 乞丐流民 | 随人流漂到此，裂隙镇收容所有人 |

## 坐标系统设计

### 坐标规则

- **x 轴**: 东(+) ← → 西(-)
- **y 轴**: 南(+) ← → 北(-)
- **z 轴**: 上(+) / 下(-) —— 多层建筑、地下室、山顶等
- **每个方向移动一步 = 坐标偏移 1 个单位**
- **每个房间有唯一坐标**，`(x, y, z)` 不重复（同一 Area 内）

### 八方向坐标偏移映射

```
      NW(-1,-1)   N(0,-1)   NE(1,-1)
           ↖        ↑        ↗
      W(-1,0)  ← [当前] →  E(1,0)
           ↙        ↓        ↘
      SW(-1,1)   S(0,1)   SE(1,1)
```

### 前端九宫格移动按钮

```
┌─────┬─────┬─────┐
│ NW  │  N  │ NE  │
├─────┼─────┼─────┤
│  W  │ 当前 │  E  │
├─────┼─────┼─────┤
│ SW  │  S  │ SE  │
└─────┴─────┴─────┘
```

- 中心格子：当前所在房间名称
- 八个方向格子：有出口时可点击（高亮），无出口时灰色/不可点击
- 前端根据 `exits` 数据决定哪些方向格子可用

### 规则移动 vs 特殊移动

| 类型 | 出口格式 | 坐标关系 | 举例 |
|------|---------|---------|------|
| **规则移动** | `{ north: "room_id" }` | 坐标偏移严格对应方向 | 街道、广场、道路 |
| **特殊移动** | `{ enter: "room_id" }` | 坐标可不连续 | 进入建筑内部、传送、楼梯 |

- 规则移动：确保坐标严格对应方向偏移，寻路算法可直接计算
- 特殊移动：enter/exit/climb 等，作为寻路的"传送节点"特殊处理
- 寻路算法主要在规则移动路径上工作，特殊移动作为可选跳转点

### 快速寻路支持

坐标规则化设计为 A* 寻路算法提供了基础：

```typescript
// 启发函数：曼哈顿距离（八方向用切比雪夫距离更准确）
function heuristic(a: Coord, b: Coord): number {
  return Math.max(Math.abs(a.x - b.x), Math.abs(a.y - b.y));
}

// 寻路结果：方向序列
// findPath(playerRoom, targetRoom) → ['north', 'north', 'east', 'enter']
```

后续实现寻路时，需要：
- 每个 Area 维护一个房间坐标索引 `Map<string, RoomBase>`（key 为 `x,y,z`）
- 寻路算法输入：起点坐标 + 终点坐标 + Area 房间图
- 寻路输出：方向指令序列，玩家可一键执行

## 裂隙镇地图布局

### 总览

规模：15 个房间，十字形布局（南北主轴 + 东西展开）。

```
y=-3          [北门·通往北境]
                   (0,-3)
                     |
y=-2           [裂谷北道]
                   (0,-2)
                     |
y=-1  [药铺]────[北街]────[铁匠铺]
      (-1,-1)   (0,-1)    (1,-1)
                     |
y=0   [酒馆]──[镇中广场]──[客栈]
      (-1,0)    (0,0)      (1,0)
                     |
y=1   [告示牌]──[南街]──[杂货铺]
      (-1,1)    (0,1)    (1,1)
                     |
y=2            [裂谷南道]
                   (0,2)
                     |
y=3          [南门·通往中原]
                   (0,3)

特殊房间（enter/exit 进入，独立坐标空间）:
  镇中广场 → down → 地下暗道入口 (0,0,-1)
```

### 房间详细定义

#### 1. 镇中广场 — 出生点核心

- **蓝图 ID**: `area/rift-town/square`
- **坐标**: `(0, 0, 0)`
- **short**: `裂隙镇·镇中广场`
- **long**: `裂隙镇的中心是一片不大的青石广场。四周断崖高耸，只在头顶留出一线天光。广场中央立着一块残碑，上面的字迹已被风雨侵蚀得模糊不清，只依稀可辨"天衍"二字。南来北往的行人在此交汇，空气中混杂着药草的苦涩和铁匠铺的炭火味。`
- **exits**: `{ north: square→北街, south: square→南街, west: square→酒馆, east: square→客栈, down: square→地下暗道入口 }`
- **NPC**: 老镇长（引导 NPC，给新玩家介绍小镇）

#### 2. 北街

- **蓝图 ID**: `area/rift-town/north-street`
- **坐标**: `(0, -1, 0)`
- **short**: `裂隙镇·北街`
- **long**: `北街是裂隙镇的商业街，两侧的铺面靠着断崖岩壁搭建。西边是飘着药香的济世堂，东边传来叮叮当当的打铁声。往北的道路逐渐收窄，通向裂谷深处。`
- **exits**: `{ south: →广场, north: →裂谷北道, west: →药铺, east: →铁匠铺 }`
- **NPC**: 路人甲（闲聊对话，提供小镇信息）

#### 3. 南街

- **蓝图 ID**: `area/rift-town/south-street`
- **坐标**: `(0, 1, 0)`
- **short**: `裂隙镇·南街`
- **long**: `南街比北街更热闹些，来自中原的商队常在此歇脚。路边有个破旧的告示牌，贴满了各种悬赏和寻人启事。东边的杂货铺门前堆着各式货物，一个瘦小的伙计正在吆喝。`
- **exits**: `{ north: →广场, south: →裂谷南道, west: →告示牌, east: →杂货铺 }`
- **NPC**: 老乞丐（信息贩子，花钱可以打听消息）

#### 4. 酒馆

- **蓝图 ID**: `area/rift-town/tavern`
- **坐标**: `(-1, 0, 0)`
- **short**: `裂隙镇·断崖酒馆`
- **long**: `酒馆依着西侧断崖而建，半截嵌入岩壁之中，终年阴凉。柜台后的酒保擦着杯子，不动声色地打量每一个进门的人。角落里坐着几个形迹可疑的客人，低声交谈着什么。墙上挂着一张褪色的天衍大陆舆图。`
- **exits**: `{ east: →广场 }`
- **NPC**: 酒保（买酒/打听消息）、神秘旅人（各势力探子，后续任务触发点）

#### 5. 客栈

- **蓝图 ID**: `area/rift-town/inn`
- **坐标**: `(1, 0, 0)`
- **short**: `裂隙镇·安歇客栈`
- **long**: `客栈是裂隙镇为数不多的两层建筑，用裂谷中的灰白岩石砌成。一楼大堂摆着几张桌椅，二楼是客房。老板娘是个爽利的中年妇人，据说她丈夫是天裂中失踪的某个宗门弟子。`
- **exits**: `{ west: →广场 }`
- **NPC**: 客栈老板（休息/恢复，后续可存档）

#### 6. 药铺·济世堂

- **蓝图 ID**: `area/rift-town/herb-shop`
- **坐标**: `(-1, -1, 0)`
- **short**: `裂隙镇·济世堂`
- **long**: `推开吱呀作响的木门，一股浓郁的草药味扑面而来。药铺不大，四面墙壁上密密麻麻地排满了药柜，每个抽屉上都贴着手写的药名。一个白发老药师正在研磨药材，旁边的炉子上咕嘟嘟地煮着什么。`
- **exits**: `{ east: →北街 }`
- **NPC**: 白发药师（买药/学习基础药理，山野药童出身的亲切感加成）

#### 7. 铁匠铺

- **蓝图 ID**: `area/rift-town/smithy`
- **坐标**: `(1, -1, 0)`
- **short**: `裂隙镇·老周铁匠铺`
- **long**: `铁匠铺里炉火通红，一个壮实的汉子正抡着铁锤锻打一块烧红的铁块。墙上挂着几柄粗陋的刀剑，虽然做工一般，但胜在结实耐用。据说老周年轻时在北境军镇当过军械匠。`
- **exits**: `{ west: →北街 }`
- **NPC**: 老周铁匠（买武器/修装备，边塞军卒出身的老乡加成）

#### 8. 告示牌

- **蓝图 ID**: `area/rift-town/notice-board`
- **坐标**: `(-1, 1, 0)`
- **short**: `裂隙镇·告示牌旁`
- **long**: `路边竖着一块被风吹日晒得斑驳的告示牌，上面贴满了各种告示：承天朝的征兵令、悬赏逃犯的画像、寻人启事、商队招护卫……有些告示已经泛黄卷边，有些墨迹未干。`
- **exits**: `{ east: →南街 }`
- **NPC**: 无（交互物件：查看告示牌可获取任务/世界信息）

#### 9. 杂货铺

- **蓝图 ID**: `area/rift-town/general-store`
- **坐标**: `(1, 1, 0)`
- **short**: `裂隙镇·万宝杂货`
- **long**: `杂货铺里堆满了各式各样的货物——从中原来的布匹、北漠的皮毛、西南的干果、甚至东海的贝壳。老板是个精明的矮胖商人，笑眯眯地对每个顾客说着同样的话："便宜卖了便宜卖了。"`
- **exits**: `{ west: →南街 }`
- **NPC**: 杂货商（买卖日用品/杂货）

#### 10. 裂谷北道

- **蓝图 ID**: `area/rift-town/north-road`
- **坐标**: `(0, -2, 0)`
- **short**: `裂谷北道`
- **long**: `离开裂隙镇的街道，道路变得崎岖起来。两侧的断崖越来越高，裂谷在此收窄，只容两人并行。岩壁上偶尔可见天裂留下的奇异纹路，在阳光下隐隐泛着微光。`
- **exits**: `{ south: →北街, north: →北门 }`
- **NPC**: 巡逻兵（提供北境信息）

#### 11. 裂谷南道

- **蓝图 ID**: `area/rift-town/south-road`
- **坐标**: `(0, 2, 0)`
- **short**: `裂谷南道`
- **long**: `往南走出裂隙镇，裂谷逐渐变宽，视野也开阔了些。远处隐约可见中原平原的轮廓。路边的岩壁上长着一些耐旱的灌木，偶尔有鸟雀掠过。`
- **exits**: `{ north: →南街, south: →南门 }`
- **NPC**: 行商（来自中原的商人，闲聊提供中原信息）

#### 12. 北门

- **蓝图 ID**: `area/rift-town/north-gate`
- **坐标**: `(0, -3, 0)`
- **short**: `裂隙镇·北门`
- **long**: `裂隙镇的北门是两块巨大的断崖之间勉强搭起的一道石墙，上面站着几个无精打采的卫兵。门外是通往北境霜疆的荒路，寒风从门缝中灌进来，带着草原的腥膻味。`
- **exits**: `{ south: →裂谷北道 }`
- **NPC**: 守门卫兵（提示"北境危险，新手勿入"，后续开放通往北境）
- **备注**: 北门外的出口（north）留给后续北境区域扩展

#### 13. 南门

- **蓝图 ID**: `area/rift-town/south-gate`
- **坐标**: `(0, 3, 0)`
- **short**: `裂隙镇·南门`
- **long**: `南门比北门气派些，用规整的石块砌成拱门，门楣上刻着"裂隙镇"三个大字。门外是一条黄土大道，通往承天朝的腹地。来往的商队和行人在此进出，卫兵例行检查路引。`
- **exits**: `{ north: →裂谷南道 }`
- **NPC**: 守门卫兵（提示通往中原方向，后续开放）
- **备注**: 南门外的出口（south）留给后续中原区域扩展

#### 14. 地下暗道入口

- **蓝图 ID**: `area/rift-town/underground-entrance`
- **坐标**: `(0, 0, -1)`
- **short**: `裂隙镇·地下暗道入口`
- **long**: `广场残碑下方有一个隐蔽的裂缝，勉强容一人侧身而入。裂缝内是一段向下的石阶，被水渍和青苔覆盖。阴冷的空气从深处涌上来，隐约带着一股古老而陌生的气息。石阶尽头被一堆碎石堵住，暂时无法通行。`
- **exits**: `{ up: →镇中广场 }`
- **NPC**: 无
- **备注**: 彩蛋预埋。碎石堵路，后续版本开放通往中古纪遗迹副本

## 出口连接总表

完整的房间出口连接关系，确保坐标与方向严格对应：

| 房间 | 坐标 | north | south | east | west | up | down |
|------|------|-------|-------|------|------|----|------|
| 镇中广场 | (0,0,0) | 北街 | 南街 | 客栈 | 酒馆 | - | 地下暗道 |
| 北街 | (0,-1,0) | 裂谷北道 | 广场 | 铁匠铺 | 药铺 | - | - |
| 南街 | (0,1,0) | 广场 | 裂谷南道 | 杂货铺 | 告示牌 | - | - |
| 酒馆 | (-1,0,0) | - | - | 广场 | - | - | - |
| 客栈 | (1,0,0) | - | - | - | 广场 | - | - |
| 药铺 | (-1,-1,0) | - | - | 北街 | - | - | - |
| 铁匠铺 | (1,-1,0) | - | - | - | 北街 | - | - |
| 告示牌 | (-1,1,0) | - | - | 南街 | - | - | - |
| 杂货铺 | (1,1,0) | - | - | - | 南街 | - | - |
| 裂谷北道 | (0,-2,0) | 北门 | 北街 | - | - | - | - |
| 裂谷南道 | (0,2,0) | 南街 | 南门 | - | - | - | - |
| 北门 | (0,-3,0) | *北境* | 裂谷北道 | - | - | - | - |
| 南门 | (0,3,0) | 裂谷南道 | *中原* | - | - | - | - |
| 地下暗道 | (0,0,-1) | - | - | - | - | 广场 | - |

*斜体*表示后续版本扩展的出口。

## Area 定义

```typescript
// area/rift-town/area.ts
Area: 裂隙镇
├── name: "裂隙镇"
├── level_range: { min: 1, max: 5 }
├── rooms: [上述 14 个房间的蓝图 ID]
├── region: "中原·裂谷地带"
└── description: "天裂后形成的裂谷中的中立小镇，各方势力的交汇之地"
```

## 蓝图目录结构

```
server/src/world/
└── area/
    └── rift-town/              # 裂隙镇区域
        ├── area.ts             # Area 区域定义
        ├── square.ts           # 镇中广场（出生点）
        ├── north-street.ts     # 北街
        ├── south-street.ts     # 南街
        ├── tavern.ts           # 酒馆
        ├── inn.ts              # 客栈
        ├── herb-shop.ts        # 药铺
        ├── smithy.ts           # 铁匠铺
        ├── notice-board.ts     # 告示牌
        ├── general-store.ts    # 杂货铺
        ├── north-road.ts       # 裂谷北道
        ├── south-road.ts       # 裂谷南道
        ├── north-gate.ts       # 北门
        ├── south-gate.ts       # 南门
        └── underground.ts      # 地下暗道入口
```

## NPC 规划

### MVP 阶段 NPC（不含 AI 行为，仅基础交互）

| NPC | 位置 | 功能 | 出身关联 |
|-----|------|------|---------|
| 老镇长 | 镇中广场 | 新手引导，介绍小镇 | 通用 |
| 酒保 | 酒馆 | 买酒，打听消息 | 江湖浪子亲切 |
| 客栈老板 | 客栈 | 休息恢复 | 通用 |
| 白发药师 | 药铺 | 买药，基础药理 | 山野药童亲切 |
| 老周铁匠 | 铁匠铺 | 买武器/修装备 | 边塞军卒亲切 |
| 杂货商 | 杂货铺 | 买卖日用品 | 通用 |
| 老乞丐 | 南街 | 信息贩子 | 乞丐流民亲切 |
| 守门卫兵×2 | 北门/南门 | 区域边界提示 | 通用 |

**备注**: NPC 暂不实现物品交易系统（无 ItemBase 实例），仅实现对话交互和文字描述。物品系统留待后续。

## 与现有系统的关系

### 依赖

- **RoomBase**: 房间基类，`getExits()`、`getExit(direction)`、`getCoordinates()`、`broadcast()` 已就绪
- **Area**: 区域管理器，`getRoomIds()`、`getLevelRange()` 已就绪
- **BlueprintLoader**: 扫描 world/ 目录加载蓝图已就绪
- **go/look/say 指令**: 八方向移动、查看房间、房间聊天已就绪
- **LivingBase.go()**: 移动到指定方向，使用 BlueprintFactory.getVirtual() 获取目标房间

### 可能需要的改动

- **BlueprintLoader 扫描路径**: 当前测试 fixtures 在 `__tests__/fixtures/world/`，实际 world 目录需要确认放在 `server/src/world/`
- **NpcBase**: 已有基础实现，NPC 蓝图可直接使用
- **PlayerBase**: 玩家登录后需要将 PlayerBase 实例 moveTo 到出生点房间

### 不需要改动

- RoomBase、Area、BaseEntity、go/look/say 指令均不需要修改
- 坐标系统 `getCoordinates()` 已在 RoomBase 中定义

## 考虑过的替代方案

| 方案 | 优点 | 缺点 | 结论 |
|------|------|------|------|
| 统一出生点（采用） | 简单，MUD 传统，工作量可控 | 出身差异体现弱 | 采用，用 NPC 亲切度补偿 |
| 按出身分 6 个出生点 | 沉浸感强 | 工作量 ×6，MVP 不现实 | 放弃 |
| 环形/复杂布局 | 更有趣 | 坐标不规则，寻路复杂 | 放弃，十字形更清晰 |
| 更多房间（30+） | 内容更丰富 | MVP 过重 | 放弃，15 个够用 |
| 不预埋地下暗道 | 更简单 | 失去世界观深度感 | 放弃，预埋一个入口不增加太多工作量 |

## 边界和约束

- MVP 阶段 NPC 仅支持对话交互，不含物品交易
- 北门/南门外的出口暂不开放，留给后续区域扩展
- 地下暗道入口被碎石堵住，暂不可通行
- 坐标系统仅在同一 Area 内保证唯一性，跨 Area 坐标独立
- 快速寻路功能本次不实现，仅确保坐标规则化为寻路预留基础

## 开放问题（留给 PRD/Design 阶段）

- BlueprintLoader 的实际 world/ 目录路径确认
- 玩家登录后如何自动放入出生点房间的具体流程
- NPC 对话系统的消息协议设计
- 前端地图展示的具体 UI 方案
- 前端九宫格移动按钮的交互细节
- 告示牌的交互机制（看做特殊 NPC 还是房间交互命令？）
- 各 NPC 的具体对话文本

## 探讨记录

### 关键决策过程

1. **坐标系统**: 确认 x 轴东正西负、y 轴南正北负、z 轴上正下负。八方向移动偏移 1 个单位。区分规则移动（坐标严格对应）和特殊移动（enter/exit，坐标可不连续），为寻路算法预留基础。

2. **前端九宫格**: 八方向出口直接映射为九宫格移动按钮，中心为当前位置。有出口的方向高亮可点击，无出口灰色。

3. **小镇规模**: 确认 15 个房间（含 1 个地下暗道入口）。十字形布局——南北主轴（广场→北街/南街→北道/南道→北门/南门），东西展开（酒馆/客栈、药铺/铁匠铺、告示牌/杂货铺）。

4. **出生点方案**: 采用裂谷中立小镇方案。所有出身角色汇聚于此各有理由，各方势力 NPC 可安排在此。

5. **地下暗道**: 确认预埋一个入口，碎石堵路暂不可通行，作为后续中古纪遗迹副本的伏笔。

6. **小镇名称**: 确认"裂隙镇"——直接点明天裂断层的地理特征。

---

> CX 工作流 | 功能探讨
