# 功能探讨: 天衍技能系统

## 基本信息

- **创建时间**: 2026-02-10
- **关联世界观**: #84（天衍世界观设定）
- **前置依赖**: ATB 战斗引擎（已完成）、经验升级体系（已完成）、装备系统（已完成）
- **后续影响**: 门派系统、NPC 拜师、战斗 AI、主动技能 UI、秘籍物品

## 功能目标

为天衍世界构建完整的武学技能体系，包含 17 个技能槽位、内外功分离的战斗招式系统、三丹田融合的内功体系、四种学习途径、严格师徒制、技能冲突机制。

整体定位为**传统 MUD 深度**数值体系，与天衍世界观深度融合——当世纪元气稀薄导致武学威力天花板，但不限制技能等级上限（凡人亦可成仙）。

## 技能分类体系（17 个槽位）

### 外功·兵刃（5 个）

| 槽位 | 英文 ID  | 说明                       |
| ---- | -------- | -------------------------- |
| 剑法 | sword    | 单手/双手剑类武器的武学    |
| 刀法 | blade    | 单手/双手刀类武器的武学    |
| 枪法 | spear    | 长杆/枪矛类武器的武学      |
| 杖法 | staff    | 棍杖类武器的武学           |
| 暗器 | throwing | 飞刀、毒针等暗器投掷类武学 |

### 外功·空手（4 个）

| 槽位 | 英文 ID | 说明                        |
| ---- | ------- | --------------------------- |
| 拳法 | fist    | 拳击类武学（硬桥硬马）      |
| 掌法 | palm    | 掌击类武学（柔中带刚）      |
| 指法 | finger  | 点穴/指力类武学（精准打击） |
| 爪法 | claw    | 擒拿/抓取类武学（控制向）   |

### 身法（2 个）

| 槽位 | 英文 ID | 说明                       |
| ---- | ------- | -------------------------- |
| 轻功 | dodge   | 闪避、移动速度、逃跑成功率 |
| 招架 | parry   | 格挡、减伤、反击概率       |

### 内功（1 个大类）

| 槽位     | 英文 ID | 说明                                                           |
| -------- | ------- | -------------------------------------------------------------- |
| 内功心法 | force   | 可学多种，但同时只能激活一种。切换时内力清零重练。与三丹田融合 |

### 辅技·百艺（4 个）

| 槽位 | 英文 ID  | 说明                                |
| ---- | -------- | ----------------------------------- |
| 医术 | medical  | 治疗、解毒、恢复类技能              |
| 毒术 | poison   | 下毒、淬毒、毒气类技能              |
| 锻造 | forge    | 武器/防具打造、修理、强化           |
| 辨识 | appraise | 中古纪/太古纪遗物鉴定，秘籍品质鉴别 |

### 悟道（1 个）

| 槽位     | 英文 ID | 说明                                                     |
| -------- | ------- | -------------------------------------------------------- |
| 武学悟性 | cognize | 加速所有武学类技能的学习效率（类似炎黄 martial-cognize） |

## 内功·三丹田融合

内功心法与现有六维属性的三丹田体系深度融合：

| 丹田          | 对应属性                        | 内功效果                             | 示例心法             |
| ------------- | ------------------------------- | ------------------------------------ | -------------------- |
| **上丹田·神** | 慧根(wisdom) / 心眼(perception) | 增强命中率、暴击率、感知力、学习效率 | 紫霞神功、先天功     |
| **中丹田·气** | 气海(spirit) / 脉络(meridian)   | 增强内力池、内力恢复、招式威力系数   | 九阳神功、纯阳无极功 |
| **下丹田·精** | 筋骨(strength) / 血气(vitality) | 增强攻防数值、血量、物理抗性         | 金钟罩、易筋经       |

### 内功规则

- **可学多种**：玩家不受学习数量限制，但同时只能**激活一种**内功心法
- **切换代价**：切换内功时内力（MP）清零，需重新修炼
- **激活效果**：激活的内功提供丹田属性加成、内力池修正、特殊被动效果
- **内功招式**：激活内功后可在战斗中使用内功特有招式（增益/恢复类），与外功招式并行

## 战斗集成

### 主动释放型

与现有 ATB 战斗引擎集成，改造为 FF 风格的 ATB：

1. **ATB 读条满**后，进入"选招阶段"
2. 战斗界面显示**可用招式按钮**（当前装备武学的已解锁招式 + 内功招式）
3. 玩家点击按钮释放招式（消耗内力/气力）
4. 若不操作（超时），则执行普通攻击
5. 普通攻击自动使用已启用武学的随机已解锁招式（被动）

### 内外功分离

- **外功招式**：攻击、防御、特殊攻击效果（流血、眩晕等）
- **内功招式**：增益 Buff、内力恢复、属性强化、特殊防御效果
- 战斗中两条线并行——外功负责输出和防御，内功负责辅助和续航

### 招式系统

每个具体武学包含一组招式（action array），按技能等级逐步解锁：

```
武学: 八卦掌 (palm)
├── Lv.0   怀中抱月 — 基础掌击，低攻中闪
├── Lv.20  猛虎伏桩 — 冲击攻击，中攻中闪
├── Lv.40  沉肘擒拿 — 控制技，中攻高闪
├── Lv.60  游空探爪 — 范围攻击，高攻中闪
├── Lv.90  金龙抓爪 — 强力单击，高攻高防
├── Lv.120 遁甲擒踪 — 追踪攻击，极高攻
├── Lv.150 劈雷坠地 — 内伤攻击，消耗内力
└── Lv.180 双打奇门 — 连击技，上中下三路
```

招式属性包含：

- `action`: 招式描述文本
- `force`: 内力消耗
- `attack`: 攻击加成
- `dodge`: 闪避加成
- `parry`: 格挡加成
- `damage`: 伤害加成
- `lvl`: 解锁等级
- `skillName`: 招式中文名
- `damageType`: 伤害类型（瘀伤/内伤/...）

## 技能等级与升级

### 无硬上限

技能等级无硬上限，但通过以下机制形成软天花板：

- **升级越来越慢**：每次 improve 的经验受当前等级影响（`amount = 1 + amount * 100 / (level + 100)`）
- **战斗经验门槛**：武学类技能升级需要消耗一定战斗经验（`level³ / 10 > combat_exp` 则无法提升）
- **纪元威力系数**：当世纪武学的伤害公式包含纪元元气系数，高等级技能的威力增长会递减

### 混合升级模型

基础：平方沉淀模型（参照炎黄 MUD）

```
升级条件: learned[skill] >= (level + 1)²
满足条件后: level++, learned 清零
```

属性影响学习效率（每次 improve 的点数受对应属性加成）：

- **武学悟性**(cognize)：对所有武学类技能提供 `amount += amount * cognize_level / 500` 加成
- **慧根**(wisdom)：影响学习时的基础 improve 点数
- **对应丹田属性**：内功技能受气海/脉络影响，外功受筋骨/血气影响

## 四种学习途径

### 1. NPC 拜师（主要途径）

- 找到特定 NPC → 满足收徒条件 → 拜师 → 消耗潜能/精力学习
- NPC 有**严格的收徒限制**：好感度门槛、属性门槛、门派归属
- 学习上限不超过师父的技能等级
- **叛师惩罚**：技能上限降低、好感度清零

### 2. 秘籍/书籍

- 通过探索遗迹、击杀 Boss、任务奖励获得武功秘籍物品
- 使用秘籍学习特定武学（可能有属性/等级前置条件）
- **纪元分级**：当世纪秘籍（普通）、中古纪秘籍（稀有）、太古纪秘籍（传说）
- 中古纪/太古纪秘籍的武学威力更高（纪元系数更优）

### 3. 自行练功

- `practice` 命令消耗气力（qi）自主练习已学技能
- 效率低于拜师学习，但不受 NPC 等级限制
- 适合突破师父等级上限后的自主提升

### 4. 战斗领悟

- 战斗中使用技能有概率触发 `improve_skill`
- 概率受技能等级、武学悟性、对手强度影响
- 高等级时概率极低，作为缓慢的被动提升途径

## 技能冲突系统

### 内功互斥

- 同时只能激活一种内功心法（通过 enable force 切换）
- 部分邪道内功与正道内功存在学习互斥（学了一方无法学另一方）

### 武学前置条件

- 高级武学可能需要特定基础技能达到一定等级
  - 例：学习「百花错拳」需要「八卦掌」和「八卦拳」均达到一定等级
- 部分武学需要激活特定内功才能施展

### 门派桎锁

- 门派武学只有门派弟子可学
- 叛出门派后门派独有技能被锁定（不删除，但无法使用和提升）
- 某些散人武学与门派武学冲突

## 死亡惩罚

照搬炎黄 MUD 机制：

1. **技能等级 -1**：所有已学技能等级各降 1 点（最低为 0）
2. **清空技能映射**：所有 enable 的映射关系清除，需重新设置
3. **不影响已学列表**：不会丢失已学的技能本身

## 数据架构

### 技能定义：TS 类继承体系

```
SkillBase (技能基类)
├── MartialSkillBase (武学基类)
│   ├── WeaponSkillBase (兵刃武学基类)
│   │   ├── SwordSkillBase (剑法基类)
│   │   │   └── [具体剑法: 独孤九剑、华山剑法...]
│   │   ├── BladeSkillBase (刀法基类)
│   │   ├── SpearSkillBase (枪法基类)
│   │   ├── StaffSkillBase (杖法基类)
│   │   └── ThrowingSkillBase (暗器基类)
│   ├── UnarmedSkillBase (空手武学基类)
│   │   ├── FistSkillBase (拳法基类)
│   │   ├── PalmSkillBase (掌法基类)
│   │   ├── FingerSkillBase (指法基类)
│   │   └── ClawSkillBase (爪法基类)
│   ├── DodgeSkillBase (轻功基类)
│   └── ParrySkillBase (招架基类)
├── InternalSkillBase (内功基类)
│   ├── ShenInternalSkill (上丹田·神系内功)
│   ├── QiInternalSkill (中丹田·气系内功)
│   └── JingInternalSkill (下丹田·精系内功)
├── SupportSkillBase (辅技基类)
│   ├── MedicalSkillBase (医术基类)
│   ├── PoisonSkillBase (毒术基类)
│   ├── ForgeSkillBase (锻造基类)
│   └── AppraiseSkillBase (辨识基类)
└── CognizeSkill (武学悟性)
```

### 玩家技能持久化：独立关联表

```
PlayerSkill 表
├── id (PK)
├── character_id (FK → Character)
├── skill_id (技能标识，如 "bagua-zhang")
├── skill_type (槽位类型，如 "palm")
├── level (当前等级)
├── learned (当前积累经验)
├── is_mapped (是否已映射到对应槽位)
├── is_active_force (是否为当前激活内功)
├── created_at
└── updated_at
```

### 技能映射表（内存）

参照炎黄的 skill_map 机制，在运行时维护：

```
skillMap: { [slotType]: skillId }
例: { sword: "dugu-jiujian", force: "jiuyang-shengong", parry: "wudang-mianzhang" }
```

## 与现有系统的关系

| 现有系统         | 技能系统的影响                                                               |
| ---------------- | ---------------------------------------------------------------------------- |
| **ATB 战斗**     | 读条满后增加"选招阶段"，支持主动释放招式按钮                                 |
| **DamageEngine** | 招式的 attack/damage/dodge/parry 加成参与伤害公式。Phase 1 的命中/暴击也对接 |
| **六维属性**     | 影响技能学习效率和战斗表现（perception→命中，spirit→暴击等）                 |
| **经验升级**     | 技能升级与角色等级独立，但共享战斗经验池                                     |
| **装备系统**     | 武器类型决定可使用的外功槽位（剑→剑法，刀→刀法）                             |
| **NPC 基类**     | NPC 需要增加技能数据、收徒逻辑、战斗 AI（使用技能）                          |
| **任务系统**     | 任务奖励可增加"秘籍物品"作为技能学习途径                                     |
| **残骸系统**     | NPC 死亡残骸可掉落秘籍物品                                                   |

## 开放问题（留给 PRD/Design 阶段）

1. **每个槽位的具体武学清单**（第一版需要哪些具体武功？每个槽位至少 1-2 个）
2. **残存三门的武学体系**（嵩阳宗/云岳派/碧澜阁各有什么武学？）
3. **纪元威力系数**的具体数值设计
4. **拜师 NPC 的具体配置**（谁教什么、收徒条件）
5. **内功招式的具体效果**（Buff 持续时间、恢复量等）
6. **辅技的具体使用场景和效果**（医术怎么用？锻造做什么？）
7. **ATB 选招阶段的超时时间**
8. **前端技能面板 UI 设计**
9. **秘籍物品的品质/稀有度体系**

## 探讨记录

### 关键决策过程

1. **整体定位**：选择传统 MUD 深度数值体系，而非简化手游向。理由：项目本身就是 MUD 游戏，深度是核心卖点。

2. **技能分类**：不照搬炎黄 20+ 槽位，也不过度简化。基于天衍世界观重新设计 17 个槽位。保留空手武学的细分（拳/掌/指/爪不合并），因为每种有独特武学风格。

3. **内功体系**：选择三丹田融合方案——不同内功强化不同丹田（精/气/神），与现有六维属性体系自然衔接。内功可学多种但只能激活一种（类似炎黄 enable force），切换时内力清零。

4. **战斗集成**：选择主动释放型（ATB 满后按钮选招），而非被动加成或纯自动。增加战斗策略深度。内外功招式分离——外功负责攻防，内功负责增益恢复，两条线并行。

5. **技能等级**：不设硬上限（"凡人亦可成仙"），通过纪元威力系数、升级递减、战斗经验门槛作为软天花板。

6. **升级模型**：混合模型——基础平方沉淀 + 属性影响学习效率。兼顾简单明确和角色差异化。

7. **拜师系统**：严格师徒制（NPC 有收徒限制、叛师有惩罚），后续具体设计。

8. **技能冲突**：完整冲突系统——内功互斥、武学前置条件、门派桎锁。增加角色构建的选择深度。

9. **死亡惩罚**：照搬炎黄——技能 -1，清空映射。保持紧张感。

10. **数据架构**：TS 类继承体系（与现有房间/NPC 一致）+ 独立 PlayerSkill 关联表。

11. **MVP 范围**：全 17 槽位一步到位，每个槽位至少 1 个具体武学实现。

---

> CX 工作流 | 功能探讨
> 创建时间: 2026-02-10
